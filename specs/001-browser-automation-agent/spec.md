# Feature Specification: Browser Automation Agent

**Feature Branch**: `001-browser-automation-agent`
**Created**: 2026-01-21
**Status**: Draft
**Input**: AI-агент для автономного управления веб-браузером с 4-agent hierarchy, ReAct loop, Accessibility Tree и Security Layer

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Simple Task Execution (Priority: P1)

Пользователь вводит простую текстовую задачу в терминале, агент открывает видимый браузер и выполняет задачу автономно, показывая свои действия и рассуждения.

**Why this priority**: Это MVP - базовая функциональность агента. Без этого нет продукта. Демонстрирует core loop: получить задачу, проанализировать страницу, выполнить действия, отчитаться.

**Independent Test**: Запустить агент с задачей "Открой google.com и найди информацию о погоде в Москве". Агент должен навигировать, ввести поисковый запрос, показать результаты.

**Acceptance Scenarios**:

1. **Given** агент запущен и браузер открыт, **When** пользователь вводит "Перейди на wikipedia.org и найди статью про Python", **Then** агент навигирует на wikipedia, вводит запрос, открывает статью и сообщает о выполнении
2. **Given** агент на произвольной странице, **When** пользователь запрашивает информацию со страницы, **Then** агент извлекает и возвращает запрошенные данные
3. **Given** агент выполняет задачу, **When** происходит каждое действие, **Then** в терминале отображаются tool calls и аргументы

---

### User Story 2 - Multi-Step Complex Tasks (Priority: P2)

Пользователь даёт сложную многошаговую задачу (поиск товаров, анализ писем, поиск вакансий). Агент самостоятельно декомпозирует задачу, переходит между страницами, взаимодействует с элементами и адаптируется к изменениям.

**Why this priority**: Демонстрирует автономность и способность агента решать реальные задачи без захардкоженных шагов.

**Independent Test**: Задача "Найди 3 ресторана с бургерами на delivery-сервисе и покажи их рейтинги". Агент должен искать, фильтровать, извлекать информацию из нескольких источников.

**Acceptance Scenarios**:

1. **Given** пользователь залогинен в почтовом сервисе, **When** агент получает задачу "Прочитай последние 5 писем и скажи от кого они", **Then** агент открывает каждое письмо, извлекает отправителя и тему, формирует отчёт
2. **Given** пользователь на странице поиска вакансий, **When** агент получает задачу найти подходящие вакансии, **Then** агент анализирует описания, применяет фильтры, собирает релевантные позиции
3. **Given** агент выполняет многошаговую задачу и страница неожиданно изменилась (popup, redirect), **When** агент обнаруживает изменение, **Then** агент адаптируется и продолжает выполнение без вмешательства пользователя

---

### User Story 3 - Destructive Actions with Confirmation (Priority: P3)

При выполнении потенциально опасных действий (удаление, отправка, оплата) агент останавливается и запрашивает подтверждение у пользователя перед выполнением.

**Why this priority**: Security layer - обязательный продвинутый паттерн из требований. Предотвращает нежелательные последствия.

**Independent Test**: Задача "Удали спам-письма из почты". Агент должен найти спам, показать список для удаления и запросить подтверждение.

**Acceptance Scenarios**:

1. **Given** агент идентифицировал письма для удаления, **When** агент готов выполнить удаление, **Then** агент показывает список писем и спрашивает "Удалить эти N писем? (да/нет)"
2. **Given** агент на странице checkout с заполненной корзиной, **When** следующий шаг - подтверждение оплаты, **Then** агент показывает итоговую сумму и товары, запрашивает подтверждение
3. **Given** пользователь отвечает "нет" на запрос подтверждения, **When** агент получает отказ, **Then** агент отменяет действие и спрашивает что делать дальше

---

### User Story 4 - Session Persistence (Priority: P4)

Пользователь может залогиниться в сервисы вручную, закрыть агента, а при следующем запуске агент сохраняет сессию и продолжает работу с теми же авторизациями.

**Why this priority**: Практическое требование для работы с защищёнными сервисами (почта, банки, соцсети) без автоматизации логина.

**Independent Test**: Залогиниться в почту вручную, закрыть браузер, запустить агента снова - сессия должна сохраниться.

**Acceptance Scenarios**:

1. **Given** пользователь вручную залогинился в сервис через браузер агента, **When** агент перезапускается, **Then** сессия сохранена и пользователь остаётся залогиненным
2. **Given** агент запущен впервые без сохранённых сессий, **When** пользователь даёт задачу требующую авторизации, **Then** агент сообщает "Требуется авторизация. Пожалуйста, залогиньтесь вручную" и ждёт

---

### Edge Cases

- **Страница не загружается**: Агент ждёт до таймаута, сообщает об ошибке, предлагает повторить или отменить
- **Элемент не найден**: Агент делает повторную попытку после скролла/ожидания, при неудаче сообщает пользователю
- **CAPTCHA появилась**: Агент обнаруживает CAPTCHA, уведомляет пользователя и ждёт ручного решения
- **Popup/modal блокирует действия**: Агент обнаруживает оверлей, пытается закрыть или обойти
- **Страница изменилась после действия**: Агент переоценивает состояние и адаптирует план
- **Максимум итераций достигнут**: Агент останавливается и сообщает о невозможности завершить задачу

## Requirements *(mandatory)*

### Functional Requirements

**Интерфейс и визуализация:**
- **FR-001**: Система ДОЛЖНА открывать видимый браузер (не headless) для всех операций
- **FR-002**: Система ДОЛЖНА предоставлять Rich TUI интерфейс с цветным форматированием
- **FR-003**: Система ДОЛЖНА отображать рассуждения агента в синих блоках [THOUGHT]
- **FR-004**: Система ДОЛЖНА отображать действия агента в зелёных блоках [ACTION]
- **FR-005**: Система ДОЛЖНА отображать результаты в жёлтых блоках [RESULT]

**Управление браузером:**
- **FR-006**: Система ДОЛЖНА поддерживать навигацию по URL
- **FR-007**: Система ДОЛЖНА поддерживать клики по элементам через естественноязыковое описание
- **FR-008**: Система ДОЛЖНА поддерживать ввод текста в поля форм
- **FR-009**: Система ДОЛЖНА поддерживать скроллинг страницы
- **FR-010**: Система ДОЛЖНА поддерживать ожидание загрузки и условий

**Анализ страниц:**
- **FR-011**: Система ДОЛЖНА извлекать структуру страницы через Accessibility Tree
- **FR-012**: Система ДОЛЖНА использовать скриншоты как fallback для визуальных элементов
- **FR-013**: Система НЕ ДОЛЖНА использовать захардкоженные селекторы или пути

**Агентное поведение:**
- **FR-014**: Система ДОЛЖНА принимать задачи на естественном языке
- **FR-015**: Система ДОЛЖНА самостоятельно определять последовательность действий
- **FR-016**: Система ДОЛЖНА адаптироваться к неожиданным изменениям страницы
- **FR-017**: Система ДОЛЖНА предоставлять отчёт о выполненных действиях
- **FR-018**: Система ДОЛЖНА использовать sliding window для контекста (последние N действий + текущий PageState)

**Безопасность:**
- **FR-019**: Система ДОЛЖНА запрашивать подтверждение перед удалением данных
- **FR-020**: Система ДОЛЖНА запрашивать подтверждение перед отправкой сообщений
- **FR-021**: Система ДОЛЖНА запрашивать подтверждение перед финансовыми операциями
- **FR-022**: Система НЕ ДОЛЖНА автоматизировать ввод паролей или прохождение MFA

**Сессии:**
- **FR-023**: Система ДОЛЖНА сохранять сессии между запусками
- **FR-024**: Система ДОЛЖНА позволять пользователю логиниться вручную

**LLM интеграция:**
- **FR-025**: Система ДОЛЖНА использовать Claude Agent SDK для orchestration агентов
- **FR-026**: Система ДОЛЖНА определять sub-agents через AgentDefinition с указанием model tier (sonnet/haiku)
- **FR-027**: Система ДОЛЖНА поддерживать OpenAI-compatible API абстракцию для альтернативных провайдеров (OpenRouter, local models)

**Обработка ошибок:**
- **FR-028**: Система ДОЛЖНА повторять действия при временных ошибках (сеть, загрузка)
- **FR-029**: Система ДОЛЖНА останавливаться и уведомлять при критических ошибках (CAPTCHA, блокировка)
- **FR-030**: Система ДОЛЖНА ограничивать количество итераций для предотвращения бесконечных циклов

### Key Entities

- **Task**: Пользовательский запрос на естественном языке, цель выполнения, текущий статус
- **PageState**: Текущее состояние страницы - URL, accessibility tree, скриншот (опционально)
- **Action**: Единица взаимодействия с браузером - тип (click/type/navigate/etc), параметры, результат
- **ContextWindow**: Sliding window контекста - последние N действий + текущий PageState для передачи в LLM
- **UserConfirmation**: Запрос на подтверждение деструктивного действия - описание, опции, ответ пользователя
- **AgentOrchestrator**: Координатор агентов через Claude Agent SDK - Planner и sub-agents (DOM Analyzer, Executor, Validator), model tiers
- **BrowserTool**: Инструмент взаимодействия с браузером - реализован через @tool decorator, schema, handler
- **LLMProvider**: Абстракция над LLM провайдером - OpenAI-compatible API для Claude/OpenRouter/local, настройки модели, endpoint

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Агент успешно выполняет простую задачу навигации и поиска информации за 10 или менее действий
- **SC-002**: Агент выполняет многошаговую задачу (5+ страниц) без ручного вмешательства в 80% случаев
- **SC-003**: Время от получения задачи до первого действия в браузере не превышает 5 секунд
- **SC-004**: Агент запрашивает подтверждение в 100% случаев деструктивных действий
- **SC-005**: Сессии пользователя сохраняются между перезапусками агента
- **SC-006**: Пользователь видит каждое действие агента в терминале в момент выполнения
- **SC-007**: Агент останавливается после 15 итераций без прогресса и сообщает о проблеме
- **SC-008**: Демо-видео показывает выполнение задачи заказа еды на Яндекс.Еда от начала до checkout

## Assumptions

- Пользователь имеет стабильное интернет-соединение
- Целевые сайты не используют агрессивную anti-bot защиту (кроме стандартных CAPTCHA)
- Пользователь готов вручную проходить авторизацию в сервисах
- Браузер Chrome/Chromium установлен в системе
- API ключи для Claude доступны в environment
